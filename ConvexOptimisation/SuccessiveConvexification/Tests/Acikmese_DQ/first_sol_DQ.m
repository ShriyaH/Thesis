function [] = first_sol_DQ()
% Asteroid descent problem for ECOS with Successive Convexification
% Shriya Hazra, 31-Jul-2018 
global ITR CONSTANTS Switch Kleopatra;

K = CONSTANTS.nodes;
alpha0 =  CONSTANTS.alpha0;

J = CONSTANTS.J;
r_F = CONSTANTS.r_F;
dq_form = CONSTANTS.dq_form;

t0 = CONSTANTS.t0;
tf = CONSTANTS.tf;
K = CONSTANTS.nodes;
ITR.t_k = (0:K-1)*tf/(K-1);
dt = (tf-t0)/K;
CONSTANTS.dt = dt;

x0 = CONSTANTS.x0;
xf = CONSTANTS.xf;
m0 = CONSTANTS.x0(1);
mf = CONSTANTS.xf(1);

dq0 = CONSTANTS.x0(2:9);
dqf = CONSTANTS.xf(2:9);

w0 = CONSTANTS.x0(10:12);
wf = CONSTANTS.xf(10:12);

v0 = quat_trans(conj_quat(dq0(1:4)),CONSTANTS.x0(14:17),'vect')';
vf = quat_trans(conj_quat(dq0(1:4)),CONSTANTS.xf(14:17),'vect')'; 

g = CONSTANTS.g; 
w_ai = CONSTANTS.w_AI;
r0 = DQ2R(dq0,dq_form);
rf = DQ2R(dqf,dq_form);
% dq = ScLERP(dq0, dqf, ITR.t_k);

ITR.x_k ={};
ITR.u_k ={};
ITR.xdot_k = {};
ITR.Ac_k = {};
ITR.Bc_k = {};
ITR.zc_k = {};
ITR.Ad_k = {};
ITR.Bd_k = {};
ITR.zd_k = {};
ITR.eta_k = {};

sol_acik = [1.99999999999911,1.96708073511322,1.93312709430099,1.89769255049301,1.86070804285828,1.82229467552899,1.78267713016103,1.74215478022400,1.70123071438145,1.66066290207294,1.62130932222630,1.58391593049132,1.54894586812880,1.51645983967712,1.48606987475628,1.45714181938728,1.42897842240743,1.40095313244658,1.37258609756302,1.34357756193338,1.31395534924985,1.28415955889196,1.25495397439791,1.22713074815541,1.20140083648858,1.17840382738926,1.15868386469249,1.14246523718221,1.12915638126085,1.11718646807745;
            2.00000000000036,1.83338169497491,1.66758306399496,1.50392288276495,1.34412368432535,1.19018719262545,1.04419434098646,0.908043390401801,0.783197201787130,0.670467355712235,0.569882506833200,0.480706562047772,0.401575995133944,0.330729571763599,0.266396285348461,0.207225338346224,0.152554891895092,0.102493879553506,0.0578451612562841,0.0199366964407202,-0.00966860613768234,-0.0296161416317624,-0.0393057921340320,-0.0392635085389805,-0.0311985886721237,-0.0179453492490899,-0.00340721438876668,0.00755953055605267,0.00993174588012042,-4.90729941750332e-13;
            0.999999999998658,1.02845450976540,1.05316683667292,1.07111644333594,1.07979640811810,1.07788182623452,1.06518969951149,1.04235024535707,1.01045310171902,0.970816705920106,0.924970761596787,0.874441713212599,0.820763525879535,0.765513086379634,0.709663763490212,0.653227052762919,0.595559085438709,0.535999934941805,0.474424975675901,0.411457902847064,0.348125874703162,0.285403755775748,0.224440864245417,0.167110308802891,0.116001512209365,0.0736683886487823,0.0416830662030745,0.0201586471148412,0.00738404870399855,1.41404287750815e-12;
            1.26720433642231e-14,-1.78802415618635e-11,-2.54001834522520e-11,-3.13614659170059e-11,-3.83229399747875e-11,-5.13167013992195e-11,-7.45221837132586e-11,-1.11907304824290e-10,-1.74995169100910e-10,-2.74811486835447e-10,-4.16626979720435e-10,-5.69322643185140e-10,-7.28994851888058e-10,-8.66069764081882e-10,-9.42233172839634e-10,-9.30363957824362e-10,-8.27889504911524e-10,-6.58606082620891e-10,-4.63475318795004e-10,-2.88446179115589e-10,-1.66942587943810e-10,-1.07945110056379e-10,-9.93037721252858e-11,-1.17640267857446e-10,-1.37664864043714e-10,-1.41746488560134e-10,-1.22603007589286e-10,-8.32768233787233e-11,-3.95141657888193e-11,-1.27760546033402e-14;
            -0.999999999998401,-0.998212202112962,-0.989821655043328,-0.972202028464967,-0.943230293728500,-0.901733015920519,-0.847967270157294,-0.783832925955650,-0.712729953798616,-0.639155476013153,-0.567879321131354,-0.503116282643550,-0.448014180029469,-0.403959373726606,-0.369554029798876,-0.341246169552961,-0.314535018224618,-0.284995610562706,-0.248948797477868,-0.203926291994189,-0.149654006100222,-0.0889640659062322,-0.0278604085245490,0.0266134887041714,0.0675294337619626,0.0882635969859152,0.0824333428654103,0.0455672169906184,-0.0192308177793524,-0.0999999999991735;
            0.199999999995635,0.185738129221696,0.154606026536697,0.105714162527367,0.0451596383981517,-0.0197423552037158,-0.0828935405988541,-0.140651112816285,-0.190955787625559,-0.232818836174608,-0.264337922735383,-0.287589368490469,-0.300923174685549,-0.305894198170350,-0.307948530328284,-0.312558912067068,-0.321830948438370,-0.333970747362893,-0.344677179453638,-0.349861397617660,-0.348866715117239,-0.342080124477921,-0.326567840487988,-0.297137183413223,-0.251093889782531,-0.191745157105617,-0.127061885929830,-0.0666066162236568,-0.0223794970570301,-2.32372666522858e-12;
            2.57974307414666e-14,-3.83115849231756e-11,-4.23665060589009e-11,-2.99718989504442e-11,-1.96743423512344e-11,-3.46275095232732e-11,-1.20317046935219e-10,-2.79878287848784e-10,-4.84693030732314e-10,-7.03613218286936e-10,-9.09144669202617e-10,-1.02504426536694e-09,-1.01045202444746e-09,-7.66392662751446e-10,-3.05217991606693e-10,2.59118640147519e-10,7.56504688912562e-10,1.05051795833516e-09,1.07039197496392e-09,8.27740979397872e-10,4.42357915980929e-10,8.16415612982907e-11,-1.65210690889874e-10,-2.55691184914344e-10,-2.18430008866940e-10,-8.47073854836052e-11,8.19475719979474e-11,1.61384104993564e-10,8.91429525805405e-11,3.56449820085459e-14;
            -4.53552626173706e-15,3.61907435756770e-11,4.95761893809721e-11,6.05029772953293e-11,7.24875742463180e-11,8.66217857460554e-11,8.65804340454954e-11,6.79946531334710e-11,3.89488427243383e-11,4.38799910275030e-12,-2.84540626586211e-11,-5.79485058136885e-11,-8.32351410545966e-11,-1.04780104130884e-10,-1.23106353203158e-10,-1.36794905156156e-10,-1.44648077885823e-10,-1.48284835946425e-10,-1.51337087977952e-10,-1.57187402474985e-10,-1.65826889235489e-10,-1.75171070284413e-10,-1.82538991350540e-10,-1.83927174393174e-10,-1.75925031615973e-10,-1.56792615183495e-10,-1.28768502224374e-10,-9.46411680013398e-11,-5.12885432737850e-11,-2.72758227169529e-14;
            -9.78655790995423e-14,4.55930138896688e-11,1.32251666112627e-11,-1.34896302999943e-11,-1.93490731094071e-11,1.18811837787558e-11,4.01365944925036e-11,6.47868103544049e-11,1.11382369640353e-10,1.97785679797695e-10,2.80739251272723e-10,4.09209170352051e-10,5.34776281122159e-10,6.27849183560668e-10,6.48800569465529e-10,5.74307676661959e-10,4.13985626148484e-10,2.06783190454814e-10,4.53325630716000e-12,-1.43411288016581e-10,-2.06735893229674e-10,-1.88588212474649e-10,-1.11972524886670e-10,-9.89093245737464e-12,7.80134744721976e-11,1.27104226895091e-10,1.34827255534768e-10,1.08404271241359e-10,5.49840970492507e-11,6.35045519026994e-14;
            2.17016250268414e-11,-0.0191784640824476,-0.0367020277452809,-0.0563591836539284,-0.0804492625225523,-0.108240492701532,-0.136289750795860,-0.159777256755472,-0.174085974069497,-0.175989976788241,-0.176094438854879,-0.164073703263631,-0.139254205347780,-0.103482193191481,-0.0599055049768359,-0.0129295139560296,0.0326267461971454,0.0726425591799770,0.104406390464497,0.126647675665022,0.138833922931018,0.140603815375172,0.132313703971893,0.115869188367894,0.0945988908234967,0.0721400980894981,0.0511815326161867,0.0329021059707148,0.0166095571940516,9.97546763027106e-12;
            1,0.999816076343764,0.999326253612595,0.998410558046069,0.996758705083421,0.994124738521142,0.990669018304298,0.987153092596937,0.984730457349764,0.984391958556181,0.984373277067386,0.986448082717665,0.990256666876299,0.994631306410713,0.998204052523065,0.999916410340815,0.999467605994605,0.997358039319774,0.994534718162305,0.991947763870985,0.990315677874275,0.990065940784726,0.991207891282771,0.993264481992065,0.995515469420222,0.997394508831705,0.998689366479417,0.999458579143074,0.999862051790054,1;
            2.95332793060853e-15,2.75253317623063e-11,4.40457302566862e-11,5.78831329421212e-11,7.08416530653696e-11,8.70077406248973e-11,1.00988391976694e-10,1.12033395401289e-10,1.22009819529256e-10,1.30953315939127e-10,1.38848744917458e-10,1.45651083782355e-10,1.51379310007835e-10,1.56223814247066e-10,1.60477562334194e-10,1.64195268760257e-10,1.67149642243296e-10,1.68941509250193e-10,1.69212033539739e-10,1.67927049383518e-10,1.64954774896461e-10,1.60349362338414e-10,1.53628745560072e-10,1.43244145698247e-10,1.28079319764738e-10,1.08854046994811e-10,8.84901864064935e-11,6.69738065167837e-11,3.80231342015224e-11,2.52682789921581e-14;
            -4.73494512175403e-14,5.53854065644864e-11,1.00896893383812e-11,-5.87393972568468e-11,-1.20909371906738e-10,-1.82637043889667e-10,-5.35179978622897e-11,3.39956186812804e-10,8.29954329082722e-10,1.25102324138331e-09,1.48781021667916e-09,1.57130268599561e-09,1.35518396447233e-09,6.14126845947694e-10,-5.51279280181440e-10,-1.78883251277370e-09,-2.66162822690102e-09,-2.89866841944126e-09,-2.44018584150606e-09,-1.43730155020560e-09,-2.69824695484880e-10,6.54916757825827e-10,1.17838605338260e-09,1.25130892101595e-09,1.00719320995664e-09,5.79186719963219e-10,1.53333712861427e-10,-4.26611397267679e-11,2.30647273459222e-11,1.63420261474733e-14;
            1.36081763823383e-11,-0.00928506562626314,-0.0594817961365422,-0.151163661536549,-0.252408601144060,-0.326504028453872,-0.346648384703545,-0.304710652206232,-0.209090452751508,-0.0805824897201478,0.0605240463547316,0.199373589322915,0.324722201658854,0.423129780119754,0.479228039733913,0.483766885780030,0.439495045521755,0.359106633450962,0.259486538227957,0.154161446065410,0.0468286695267849,-0.0589437996106170,-0.147907097601652,-0.199984873162355,-0.204727872031792,-0.168636236681957,-0.109706663820682,-0.0486642204289536,-0.00959648184846396,-5.63521454214065e-12;
            2.00000000000058,2.04430539170590,2.11511208596311,2.21032048035926,2.31697295118004,2.41672810144998,2.48981672678117,2.52671750980628,2.52397988786653,2.47800818327244,2.38612862693310,2.25366640795767,2.09925504718980,1.95325706204948,1.83748245414109,1.75772334384237,1.71608252526532,1.71165754031362,1.73828541881854,1.77638974281514,1.79701025265322,1.77877906187845,1.71663459328587,1.61368557553384,1.47244282522523,1.29781368190746,1.09849230918254,0.907662944512630,0.782585559316323,0.749999999998097;
            1.09802496700326e-11,-0.0774389187952135,-0.226386695054823,-0.314503631968912,-0.287617141499237,-0.159017351525130,0.0243294933135459,0.206430714410908,0.341441699009732,0.408367527299602,0.420738854847001,0.397382182806240,0.339249823349268,0.235739959155831,0.0912382334791623,-0.0637480258731836,-0.193119991290721,-0.274824692253723,-0.306506625846246,-0.313225432695107,-0.316861394729134,-0.294470801778595,-0.212348100777766,-0.0788249167234864,0.0603858521065846,0.156811360715023,0.193693851244092,0.160045426670233,0.0617344310094082,1.70497151562600e-11;
            2.58812620147624e-14,1.07859334793353e-10,1.92678567651277e-10,2.04693496994822e-10,1.48667902561127e-10,-2.34338956943239e-10,-9.08091344411896e-10,-1.40020450238878e-09,-1.43575520409074e-09,-1.06434942221676e-09,-4.40771447718583e-10,3.29553860692535e-10,1.64716568747613e-09,3.22613556612853e-09,4.02862590224303e-09,3.54672922112987e-09,1.93265131767401e-09,-1.52679369477344e-10,-2.10344947129667e-09,-3.21565648797377e-09,-2.97604583341098e-09,-1.91878301508388e-09,-6.72333365674644e-10,4.05712308690180e-10,1.09579448009347e-09,1.38471843988213e-09,1.03012016972345e-09,1.33462256814436e-10,-2.18602816497797e-10,-7.17722773232425e-14;
            2.13018668150505e-13,0.131363348400137,0.325665502975011,0.432214619943366,0.471365199020874,0.358170070578758,0.160427005680212,-0.0667436408899333,-0.305731301301145,-0.576059857307263,-0.847338061054107,-1.05301139338554,-1.10180174289090,-0.943884900058841,-0.731417970469502,-0.504361671840234,-0.266859247677332,-0.0506279858356258,0.113116478748047,0.0958217308686814,-0.0876111048607921,-0.360089154950928,-0.605530034669437,-0.840458065630086,-1.05570856443757,-1.23187705556225,-1.34307325908638,-1.11764117846400,-0.545737108490239,-5.40321098612682e-14;
            2.29420447752610e-12,-0.912612990782854,-0.870359265726780,-0.189443817387442,0.507098115170105,1.03152680286597,1.16628088455391,1.01943717180324,0.603570656138840,0.203223756105895,-0.0508431239980731,-0.230207084178437,-0.468358623196882,-0.773479532324538,-0.959542010637486,-0.899361410303572,-0.653163690287773,-0.329328668281607,-0.0558151178704323,-0.0276330777736476,-0.0177829237992647,0.290033012447249,0.695469944742914,0.904564847418223,0.763539137541311,0.393940994941770,0.0557097129673715,-0.462274911935972,-0.704024812905713,-2.50598923437771e-12;
            5.66355937660841e-15,6.98577748852019e-10,3.91015536434703e-11,5.35186144557508e-11,-7.40574806060463e-10,-3.82834171464237e-09,-4.28042279862934e-09,-1.64022896630597e-09,1.22619236479760e-09,3.26038361750803e-09,4.27489116643683e-09,4.88519107372415e-09,1.07643312572546e-08,8.00222212758384e-09,1.44243426345379e-09,-7.41426953463061e-09,-1.21554552832077e-08,-1.30976097625592e-08,-1.05897053325392e-08,-2.99930816766167e-09,5.65477953193836e-09,6.87945664817311e-09,7.92791745202002e-09,4.94391005973527e-09,3.33694337855847e-09,1.57645664590849e-10,-4.39705637733118e-09,-6.48869383083529e-09,2.11486065935344e-09,6.93225513370781e-15];
for k = 0:K-1
    ii = k+1;    
    % construct linearisation point states
    m_k = ((K-k-1)/(K-1))*m0 + (k/(K-1))*mf;
    r_k = ((K-k-1)/(K-1))*r0 + (k/(K-1))*rf;
    dq_k = Q2DQ(dq0(1:4),r_k,dq_form);
    v_k = ((K-k-1)/(K-1))*v0 + (k/(K-1))*vf;
    v_k = quat_trans(dq_k(1:4),v_k,'n');
    w_k = ((K-k-1)/(K-1))*w0 + (k/(K-1))*wf;
    dw_k = [w_k;0;v_k];
    gb = quat_trans(dq_k(1:4),g,'vect')';
    F = -(m_k*gb);
    dF_k = [F;0;cross(r_F',F')';0];
    Fdot_k = -alpha0*norm(dF_k(1:4))*gb;
    dFdot_k = [Fdot_k;0;cross(r_F',Fdot_k')';0];
%     
%     m_k = sol_acik(1,ii);
%     r_k = sol_acik(2:4,ii);
%     q_k = sol_acik(8:11,ii);
%     dq_k = Q2DQ(q_k,r_k,2);
%     v_k = sol_acik(5:7,ii);
%     v_k = quat_trans(q_k,v_k,'n');
%     w_k = sol_acik(12:14,ii);
%     dw_k = [w_k;0;v_k];
%     F = sol_acik(15:17,ii);
%     dF_k = [F;0;cross(r_F',F')';0];
%     dFdot_k = [sol_acik(18:20,ii);0;0;0;0;0];
%     gb = quat_trans(dq_k(1:4),g,'vect')';

    wa = quat_trans(dq_k(1:4),w_ai,'n');
    wa = [wa;0;0;0;0];
    Wa = omega_tensor(wa,4);
    
    x_k  = [m_k;dq_k;dw_k;dF_k;dFdot_k];
    ITR.x_k{1}(:,ii) = x_k;
    
    u_k = zeros(8,1);
    ITR.u_k{1}(:,ii) = u_k;
        
    if k<K-1       
        J_k = dq_inertia(m_k,J);
        [U, S, V] = svd(J_k);
        J_inv_k = V*(S\U');
        
        % construct linearisation point state differential
        mdot_k = -alpha0*norm(dF_k(1:4));
        dqdot_k = 1/2.*(omega_tensor(dw_k,3)*dq_k);
        dwdot_k = J_inv_k*(dF_k - omega_tensor(dw_k,4)*(J_k*dw_k) + [m_k.*gb;0;0;0;0;0]);

        xdot_k = [mdot_k;dqdot_k;dwdot_k;dFdot_k;u_k];
        ITR.xdot_k{1}(:,ii) = xdot_k;
    end
end

ITR.m_spent(1,1) = ITR.x_k{1}(1,1) - ITR.x_k{1}(1,end);
end