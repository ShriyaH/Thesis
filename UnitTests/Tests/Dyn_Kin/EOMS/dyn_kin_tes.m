%% Dynamics and Kinematics block check 
%Inertial, Relative in A, Relative in B, Relative in B with DQ, 6dof with
%and without controls
clear data
clc
global Sun SC I m mu Kleopatra Var Switch

%% Common Input Values 
% Initialize_models;

%% Select Integrator 
Switch.Razgus = 0;
Switch.Q = 0;
Switch.Q_rel = 0;
Switch.DQ = 0;
Switch.DOF6 = 1;
Switch.DOF6_lin = 0;

%% Plot
Switch.Q_plots = 0;
Switch.convert_q = 0;
Switch.kepler_el = 0;
Switch.kepler_n= 0;
Switch.err = 0;

%% Initialize
if Switch.SRP
    %For SRP check 
    x_I = [0   0   100e3];
    v_I = [0 -41.787629748527260 0];
    w_BI = [0 0 0];
    w_AI = [0 0 0];
elseif Switch.TBP
    %For 3RP check 
    x_I = [0 100e3 0];
    v_I = [-41.1527817563532 0 7.25634575485216];
    w_BI = [0 0 0];
    w_AI = [0 0 0];
elseif Switch.DOF6 || Switch.DOF6_lin
    m_sc = 2;
    g = [-1;0;0];
    x_I = [2; 1; 0];
    v_I = [-1; 0.2; 0]; 
    q_BI = [0; 0; 0; 1]; 
    w_BI = [0; 0; 0]; 
    Th_B = [2; 0; 0];
    Th_dot_B = [0;0;0];
    I = 0.5.*eye(3);
    w_AI = [0 0 0];
    u = [2.56587820108167,3.99266588430566,0.978021501846517,-0.597950345991760,...
    -3.00385836546618,-3.18401018259941,-2.85661368948329,-2.78609166740569,...
    -4.66639400982699,-4.55089114507239,-3.28503290444219,-0.179902744911664,...	
    2.66472434555527,4.72168971038681,5.56482896733056,5.58549498763925,...
    4.68639443093420,3.96040236275891,2.85576174004548,-1.17583667081550,...	
    -3.30866907158830,-4.04806637185807,-4.33460066713889,-5.07623965657771,...	
    -5.19064355272963,-3.40331750604941,-0.893385556455460,6.43134403106353,8.53413753365434,0;
    -9.89380961871234,3.45296850303132,7.94753781522837,7.05501859973264,...
    1.69413244775209,-2.13750702207513,-4.06834859344495,-4.20301079756376,...
    -1.93473799605713,-0.578972990664162,-0.0150289581556460,-0.274979751743707,...
    -0.651789005545169,0.103072417540174,1.53160081783541,1.41709400770654,...
    -0.366329418886211,-1.07094279857290,-0.262716528342716,0.132694461974571,...
    0.522450895509362,3.26377226903777,4.76846362117490,1.79486417303638,-2.45489548805800,...
    -5.53381134556841,-4.19204284678611,-1.42416676779499,5.37873340126128,0;
    0.0139643249145358,-0.00551166811788279,-0.0154517655281686,-0.0295261083090259,...
    -0.0204315619275735,-0.00700130106598788,0.00282704981612779,0.0148035766548615,...
    0.0595460458220143,0.0429859312907470,0.0450309450519581,0.0478862170595148,...
    0.0462473536968840,-0.0184667412077176,-0.0763711847216189,-0.140818591373701,...
    -0.119839189093742,-0.0426032812462433,0.00789981992040960,0.0841419757478245,...	
    0.0525952984728003,0.0495998323713686,0.0315522724535539,0.0272814056389653,...
    0.0183113488896174,-0.00547706853034973,-0.0316617630450550,-0.0371172132611443,...
    0.00561689149866950,0];
tdot = [1.82382650187413e-11	0.427660837434587	1.09310096301659	1.25608771398764	1.15641140284070	0.655761989209051	0.125116217641902	-0.350912497601917	-0.815244542127294	-1.59299391771409	-2.35150608396107	-2.89904020751512	-2.92904158508365	-2.48492378874503	-1.69796603718246	-0.770480779832495	0.160441575129415	0.941523132406715	1.60160811087720	2.07757549239061	1.88160092227050	1.33013838413666	0.655446799551624	-0.0669977222978063	-0.913045568880394	-1.77815764228978	-2.34538230071663	-2.49429304184006	-1.42238478355681	-8.04857734141883e-13
       -1.19457262135847e-10	-1.64895138475302	-1.07339595664542	0.251223841832637	1.42705185801368	1.70936922283710	1.35307676076444	0.675001896724150	-0.0254957404396612	-0.347935875191188	-0.444419232725705	-0.446919819633802	-0.492749440092619	-0.601379972954660	-0.584198880228078	-0.328933390075204	-0.0927681621548848	-0.153833873034992	-0.332317490274969	-0.376114072421492	-0.353995374228317	-0.266950941380135	0.277033268838724	1.07180793728920	1.37096080600296	0.961791001816844	0.0394671911370365	-0.659153854822835	-0.896547448443459	-4.98444138206904e-13
        5.54029448166726e-12	0.00232835901279258	0.00140744876434318	-0.00117138385721471	-0.00609571371676464	-0.00950308001968412	-0.0106703447156261	-0.0101976672954591	-0.00772685183025909	0.00220283077081692	0.00937358328761636	0.0168852171494109	0.0248713448752074	0.0325810944737722	0.0294998188586651	0.0167604534896697	-0.00672996737041293	-0.0267108344362954	-0.0338125131088491	-0.0324928258043733	-0.0184643137696944	-0.00969381113679817	-0.00142226086063334	0.00384037979261287	0.00838938348752624	0.0114411797103436	0.0105265184454342	0.00524705607349074	-0.000939998731099354	-4.75938300190442e-13];
vk = [-0.000697530038365323,-0.000626148624580034,-0.000444973559774291,-0.000203995724656366,3.78036312133241e-05,0.000249298660206493,0.000426452397968623,0.000572436628113664,0.000687285341724521,0.000773838452953202,0.000826189927431726,0.000836172952271312,0.000814774354254949,0.000783271807460981,0.000755790295653832,0.000731066781819361,0.000700624204524084,0.000658225220281007,0.000599756326816651,0.000523576765480316,0.000433522107455770,0.000333788367240040,0.000232251538084999,0.000156409598116230,0.000143198601509847,0.000206160290491803,0.000309961749401750,0.000382262938696956,0.000355590791733813,0;
    0.000222190642700492,0.000222191443478965,0.000222193938007643,0.000222197390084004,0.000222205675253221,0.000222225022058779,0.000222260446550723,0.000222301044781377,0.000222322006399107,0.000222368956813257,0.000222424677915955,0.000222483343113924,0.000222529503962711,0.000222563007016978,0.000222645073460353,0.000222762291308932,0.000222894270230801,0.000223014782106463,0.000223111149809370,0.000223160835092080,0.000223235581130874,0.000223296397092476,0.000223362082587655,0.000223395296295435,0.000223404725321757,0.000223411773730418,0.000223412326155267,0.000223411813006197,0.000223410911139521,0;
    -0.00366411343514315,-0.00366411025391924,-0.00366410527759840,-0.00366410212232462,-0.00366409300464903,-0.00366408304702928,-0.00366407720222738,-0.00366407013616913,-0.00366404078492650,-0.00366405728980000,-0.00366402628957180,-0.00366399779322082,-0.00366398066635327,-0.00366397181901010,-0.00366395717540949,-0.00366394259766520,-0.00366393033899038,-0.00366392099185632,-0.00366391407758416,-0.00366391071005897,-0.00366390639983446,-0.00366390386749417,-0.00366390235044652,-0.00366390310468208,-0.00366390472354634,-0.00366390866928669,-0.00366391099623024,-0.00366391203131364,-0.00366391439932529,0;
    -1.05265870454826e-05,-1.05269138698749e-05,-1.05273352829085e-05,-1.05272122364189e-05,-1.05258633602098e-05,-1.05213884785972e-05,-1.05115443894569e-05,-1.04984809253674e-05,-1.04904456607334e-05,-1.04743027931292e-05,-1.04566112711403e-05,-1.04434189903077e-05,-1.04379022763031e-05,-1.04369224883252e-05,-1.04396873341694e-05,-1.04475432498901e-05,-1.04570992018953e-05,-1.04635891779900e-05,-1.04652627301043e-05,-1.04637065545598e-05,-1.04571083268082e-05,-1.04478092271922e-05,-1.04327194884289e-05,-1.04217178920619e-05,-1.04170623999781e-05,-1.04108173791648e-05,-1.04087857789670e-05,-1.04081529682044e-05,-1.04076130871684e-05,0;
    -7.46812844867687e-05,-0.000111710982074487,-0.000148732778263487,-0.000185750369544552,-0.000222753112984493,-0.000259736823046905,-0.000296712747784895,-0.000333712115218130,-0.000370744027597822,-0.000407769452736846,-0.000444775670044192,-0.000481774351199680,-0.000518796521656743,-0.000555848141396908,-0.000592877152670925,-0.000629932057137139,-0.000667045365105071,-0.000704225065453062,-0.000741456335335365,-0.000778694848419838,-0.000816003972014284,-0.000853336381764582,-0.000890730420467025,-0.000928075576919108,-0.000965354800128108,-0.00100264709937932,-0.00103989840170750,-0.00107713580663599,-0.00111436818231090,0;
    -0.00968430525813377,-0.00907361458577370,-0.00846293375410161,-0.00785225762804935,-0.00724157047382724,-0.00663087229386776,-0.00602016025083887,-0.00540943724870195,-0.00479870569521511,-0.00418803996701584,-0.00357734768763159,-0.00296668357124354,-0.00235603149700268,-0.00174537956376003,-0.00113474288707343,-0.000524111807924894,8.65227385688584e-05,0.000697163081265465,0.00130780436562079,0.00191844832956072,0.00252908401262246,0.00313972058514419,0.00375035195015442,0.00436098496212567,0.00497162572229176,0.00558226271935116,0.00619291172904370,0.00680356328650998,0.00741421880404979,0;
    1.16784879932447e-05,1.34334223930189e-05,1.51912865789162e-05,1.69509711054534e-05,1.87166027078745e-05,2.04919589586101e-05,2.22765964836544e-05,2.40568551153832e-05,2.58174091369552e-05,2.75758429655328e-05,2.93171440936764e-05,3.10413366928850e-05,3.27619735381294e-05,3.44876277422152e-05,3.62022331796854e-05,3.79265489582664e-05,3.96740430511026e-05,4.14405290340263e-05,4.32118174165767e-05,4.49709828316383e-05,4.67333018020166e-05,4.84839544109833e-05,5.02214049128404e-05,5.19484655781302e-05,5.36770264912327e-05,5.53970386200445e-05,5.71250956436485e-05,5.88570888386203e-05,6.05890923408929e-05,0;
    -6.20680291450409e-05,-6.18978727643652e-05,-6.06308888739355e-05,-5.78795628792723e-05,-5.39907944804055e-05,-4.97432207239494e-05,-4.59739920722591e-05,-4.33150505908466e-05,-4.06220836747315e-05,-3.78344373374971e-05,-3.65144401135199e-05,-3.68611650074426e-05,-3.87657531703944e-05,-4.15743662667254e-05,-4.41167109395640e-05,-4.53341180059681e-05,-4.48181240965952e-05,-4.28615121393746e-05,-4.02045483357804e-05,-3.78268620764429e-05,-3.64979631178464e-05,-3.64871384359189e-05,-3.82374355100143e-05,-4.26173970049285e-05,-4.99155462809357e-05,-5.88115711093173e-05,-6.67598711119200e-05,-7.16484113853832e-05,-7.31613462938587e-05,0;
    -0.000115819762701082,-0.000111558936843605,-0.000106695703763474,-0.000101137237070190,-9.45310472293712e-05,-8.63725942320616e-05,-7.63056739840131e-05,-6.42462018634097e-05,-8.10633199870805e-05,-8.13595459075204e-05,-6.64319014116864e-05,-5.26339558120548e-05,-4.07344734409490e-05,-3.08977215420805e-05,-2.26723940791002e-05,-1.52441952191076e-05,-7.64649630717245e-06,1.08068206569858e-06,1.20021866266833e-05,2.62620708081057e-05,4.45927531264730e-05,6.68500222712960e-05,9.22566365269676e-05,0.000119633623329723,0.000147509435204622,0.000174088191246953,0.000197570108000729,0.000216494876805748,0.000231283547999869,0;
    -0.0143650424218456,-0.0110777262072607,-0.00772006970010431,-0.00421113956070218,-0.000555574252295668,0.00315898062727458,0.00678449650622254,0.0101761118772977,0.00470581172180119,-0.000888464263711061,0.00113197910444425,0.00257120962998664,0.00348522634317671,0.00399948416632517,0.00425928863188650,0.00437845972334064,0.00440998468057530,0.00434481135808138,0.00412222480097416,0.00363567067355687,0.00276551213286710,0.00142902802019940,-0.000407192604682029,-0.00271838283871272,-0.00539122129736795,-0.00820277686320487,-0.0108618009814921,-0.0131000168649434,-0.0148959595280644,0;
    0.00132705466033515,0.00107923122194374,0.000404172031227622,-0.000442136650949573,-0.00111279019346469,-0.00141016813366225,-0.00135405212456894,-0.00109773589451760,-0.000917388321427908,-0.000745725423752114,-0.000570390272926402,-0.000421655021215069,-0.000327410424770868,-0.000307723959416828,-0.000353043157910869,-0.000421590633734593,-0.000468095139901740,-0.000462018638849960,-0.000374695574569504,-0.000174996350398180,0.000152781028516857,0.000602521681238104,0.00112023722656543,0.00156513499712563,0.00177696566711159,0.00170712356220799,0.00148327967346842,0.00132568249448563,0.00140165384212713,0;
    -4.80394264283158e-05,-4.29589428154345e-05,-3.80469554449303e-05,-3.34790663942585e-05,-2.94441252315669e-05,-2.60372406025581e-05,-2.31991897801754e-05,-2.07152916855243e-05,-1.85961407667362e-05,-1.66355775018841e-05,-1.46104171938911e-05,-1.22747064217532e-05,-9.45413248642994e-06,-6.07541496786260e-06,-2.19361844883050e-06,2.01936946278560e-06,6.31783918303929e-06,1.04500501923940e-05,1.42153141632268e-05,1.75027714732432e-05,2.03020387537340e-05,2.27060104263975e-05,2.49079017433010e-05,2.72358326648968e-05,3.00988307350828e-05,3.38230923804034e-05,3.84921866320452e-05,4.39132818003988e-05,4.97757270685044e-05,0;
    -4.32212001296962e-05,-3.37037561582784e-05,-2.45132136339393e-05,-1.56545350603119e-05,-7.16558787732744e-06,8.52878310633329e-07,8.24454307862399e-06,1.48227624670305e-05,2.27595165340259e-05,3.07237615327238e-05,3.74920714918293e-05,4.30452691857634e-05,4.74191048704417e-05,5.07491152434153e-05,5.32408016545673e-05,5.48860154749443e-05,5.56687924022771e-05,5.55778152056582e-05,5.45621171038686e-05,5.25030934834130e-05,4.90202737923086e-05,4.38723025970823e-05,3.67347320987977e-05,2.74823728872529e-05,1.60056563167263e-05,2.31257100241499e-06,-1.33794269854699e-05,-3.07608816319242e-05,-4.94801156968552e-05,0;
    -6.36371801840070e-05,0.000993392392231454,0.00177278204750376,0.00226762095352155,0.00246895856443127,0.00237116524811358,0.00197574885919404,0.00129352619397028,0.00104412521271930,0.00123244659952184,0.00122951207626669,0.00108129858368150,0.000833217820112391,0.000523873250134414,0.000180847597894949,-0.000179210470751630,-0.000546725520471168,-0.000913783519403447,-0.00126918020002406,-0.00159427263593836,-0.00186061446070201,-0.00203155189922309,-0.00206649802975708,-0.00192625903354320,-0.00157871488309085,-0.00100537046619225,-0.000207180044758409,0.000792963884418448,0.00195999938496237,0;
    0.000129147887953602,0.000102581331260169,5.94692623812330e-05,-2.33556048372524e-05,-0.000116432768718135,-0.000238159049768295,-0.000379720901845669,0.000273648157060528,0.000142543124138831,3.45056770506339e-05,-4.49150283988042e-05,-8.78349181091342e-05,-9.20384072295943e-05,-6.02321651920111e-05,4.93497207943793e-07,8.00009895682228e-05,-1.38957898715095e-05,2.97977638261765e-05,0.000103897465253466,8.31091839996026e-05,0.000117290679636985,-1.32716845171825e-05,-1.59705643003962e-05,-2.23448975654502e-05,-1.70574783913137e-05,1.41680611778876e-05,7.87948417887216e-05,-0.000136668827402145,-2.49558965790589e-06,0;
    -0.000621331461308955,1.19455358334191e-05,0.000301325117051532,0.000236186903890340,0.000114253928786041,-6.98595101446894e-05,-0.000217397886499206,-0.000124257696705290,-2.30245794412978e-05,4.57565800483924e-05,3.84147923103586e-05,7.81761299550903e-06,-1.10662241771370e-05,1.24705502560730e-06,5.33857381771829e-05,0.000148774277169000,3.78866403115832e-05,-8.86568562108673e-06,0.000223334000370570,5.69474678280509e-05,0.000348663707709380,-0.000178388631811412,5.74700941486242e-05,0.000186277715174769,0.000138426240736091,-0.000162626052076838,-0.000794044888533002,-4.01176500432518e-05,-0.00153474348311111,0;
    2.72878463878516e-05,1.34627486673578e-05,2.64017293869687e-06,-5.18520793522622e-06,-1.04160210545618e-05,-1.31038863552405e-05,-1.34854856608045e-05,-1.30964131191899e-05,-9.21448024068560e-06,-3.03517428070957e-06,5.31752570225833e-06,1.54979027738520e-05,2.71420703447001e-05,3.98970980463081e-05,5.35836662892298e-05,6.79159062881958e-05,-7.14513895611632e-05,-3.48904906994080e-05,-2.12140766649324e-05,-6.05553579577934e-06,5.38301639990646e-06,2.05841414111382e-06,9.20833091566143e-06,1.32885219542362e-05,1.35740822368257e-05,9.21325878913158e-06,-4.38821594253907e-07,-1.79529603267245e-05,-3.99594051654559e-05,0;
    1.44705517183558e-05,-4.18848482684818e-06,-1.68326849493847e-05,-1.79201578409753e-05,-6.35272496362516e-06,2.25922000349072e-05,7.35663421803699e-05,1.65667133742224e-05,-1.70406120241408e-05,-3.03087320458931e-05,-2.86394780495194e-05,-1.75867480950731e-05,-2.92791917561272e-06,9.46649898033301e-06,1.37627952655276e-05,6.52368863348166e-06,1.58187879789626e-05,1.79180103285869e-05,7.09150538588740e-06,-1.79165143994935e-06,-1.76928698247338e-05,-1.38559427066621e-05,-1.10773269401061e-05,-7.90382028918095e-06,-4.81462176905898e-06,-5.07408595768800e-06,-1.31483815577978e-05,1.75864385633908e-05,2.85279461452142e-05,0;
    1.68852326458797e-05,6.06776449517946e-05,3.01626147976336e-05,-8.41710398698312e-06,-3.80431347049942e-05,-4.12917278683996e-05,-1.67651342488220e-05,4.16242836059462e-06,1.61979231753707e-05,1.21409083682153e-05,4.23945034697997e-06,3.38164608530881e-07,9.68061931799228e-07,2.35646998100198e-06,-1.31281934251170e-06,-1.71066969006016e-05,-1.08077327243276e-05,6.84918879088430e-06,-1.04940893219164e-05,2.95453086439894e-06,-3.07164034262603e-05,2.21653795938102e-05,3.07315884860772e-05,8.83987475578482e-06,-2.05561763567575e-05,-2.19197520407753e-05,5.27618371095676e-05,-3.24656555825990e-05,9.18815655815481e-05,0;
    9.71517425253211e-07,-2.29889821905761e-06,-3.53836865545737e-06,-3.31180917194421e-06,-2.10598226021585e-06,-3.81185191134529e-07,1.50245076311736e-06,3.55268943124144e-06,5.34163084338566e-06,6.43063510246011e-06,6.47635316440663e-06,5.09154912114701e-06,1.85731547847395e-06,-3.48541426459070e-06,-1.08345827325743e-05,-2.06556321009867e-05,-7.66888414178331e-06,-1.13179842721455e-06,3.05065108006691e-06,4.84941022989002e-06,4.61955440958294e-06,4.91154793675280e-06,3.92857796791297e-06,2.10275534457744e-06,-9.52586202898552e-08,-1.81650980912111e-06,-2.50186456894754e-06,-8.52594686440676e-07,3.85014703589447e-06,0;
    0.0177847747910336,0.0148698302605741,0.0121792900700723,0.00991728764496129,0.00858200138017689,0.00867402366552216,0.0100975582406102,0.0122354600941111,0.00782435371235400,0.00588715376770973,0.00550305666804168,0.00558396309628653,0.00573781636216629,0.00581550399324750,0.00583063039558718,0.00583966525955015,0.00586493956460692,0.00590124146634794,0.00590814097662160,0.00581747856602066,0.00565708037631092,0.00554502990367111,0.00583927221581562,0.00685447819164866,0.00859694512993507,0.0108147953988631,0.0131876513366311,0.0153344914836680,0.0173188767356704,4.57128755872714e-07];
vvv = [9.68114477473137e-13,0.0521495780175925,0.151726988468219,0.292182556995476,0.446819326605849,0.591083767088906,0.696984710389410,0.751503801244394,0.750089274057268,0.675465770061055,0.520219496275290,0.295499046134471,0.0300374882243992,-0.229291865320915,-0.435738323362226,-0.556847877487349,-0.579643722739756,-0.505245789519590,-0.337407094722579,-0.0893426456187008,0.186831375255389,0.436649369565427,0.627738140184373,0.727150010218297,0.708175410823724,0.557834700138776,0.287737182740289,-0.0630812383461865,-0.366518893511076,0;
    -1.24390859463198e-10,-0.0993789623788067,-0.251190236568459,-0.344860825728738,-0.357770604546702,-0.320405025547700,-0.272171560676230,-0.230995796891871,-0.198823217556306,-0.182040717491863,-0.147405342214354,-0.0830720372952215,-0.0213673884146633,0.00147378094266445,-0.0219694083647378,-0.0614184925768027,-0.0831358677680960,-0.0835429636684905,-0.0708968912656721,-0.0392259795709274,0.00803696577579557,0.0509676665245212,0.0976856907572993,0.185384703114746,0.307914268405291,0.404003359108001,0.406658966747190,0.294653512337679,0.116810009346908,0;
    2.22033064388740e-11,0.000367103193657552,0.000884221168946284,0.00136936190043110,0.00161009799816603,0.00146620427978214,0.000922021285232417,-7.62450470581437e-05,-0.00157343572951789,-0.00308543449091134,-0.00421098197698480,-0.00456731715153589,-0.00346300180993999,-0.000567635785030537,0.00328554190002336,0.00638006226862473,0.00710296627905750,0.00490600357664589,0.00117137064150560,-0.00248459079159000,-0.00453349615460951,-0.00469220853710124,-0.00379356648661184,-0.00247800924522682,-0.00122701549328051,-0.000182296581400914,0.000555167941013501,0.000796429495457861,0.000468143220557647,0];
else
    %For dynamic block check
    x_I = [0 60e3 0];
    v_I = [53.947598031175893 0 0];
    w_BI = [6.28318e-4 0 0];
    w_AI = Kleopatra.w_AI;
end
W_AI1 = omega_tensor(w_AI,1);                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
W_AI2 = omega_tensor(w_AI,2);

% q_BI =[0 0 0 1];
% q_AI = [0 0 0 1];
% C_AI = Q2DCM(q_AI);
C_BI = Q2DCM(q_BI);

%% Inertial Dynamics and Kinematics
if Switch.Q 
    [Var.t,Var.y] = test_inert_eom(x_I,v_I,w_BI,q_BI,q_AI,W_AI2); %integrate for inertial frame (Cartesian and Quaternions)

%Convert to relative frame 
    for i = 1:length(Var.y)
        Var.norm_ri(i) = norm(Var.y(i,1:3));
        
        q_IA(:,i) = conj_quat(Var.y(i,14:17)');
        C_AIt(3*i-2:3*i,:) = Q2DCM(Var.y(i,14:17)');

        C_BIt(3*i-2:3*i,:) = Q2DCM(Var.y(i,10:13)');

        Var.q_BAt(1:4,i) = cross_quat(Var.y(i,10:13)',q_IA(:,i));
        C_BAt(3*i-2:3*i,:) = Q2DCM(Var.q_BAt(1:4,i));

        Var.r_At(:,i) = C_AIt(3*i-2:3*i,:)*Var.y(i,1:3)';
        Var.r_Bt(:,i) = C_BAt(3*i-2:3*i,:)*Var.r_At(:,i);

        Var.v_At(:,i) = C_AIt(3*i-2:3*i,:)*Var.y(i,4:6)'- W_AI1*Var.r_At(:,i);
        Var.v_Bt(:,i) = C_BAt(3*i-2:3*i,:)*Var.v_At(:,i);

        Var.w_BA_b(:,i) = Var.y(i,7:9)'- C_BAt(3*i-2:3*i,:)*w_AI';
        Var.w_BA_a(:,i) = C_BAt(3*i-2:3*i,:)'*Var.w_BA_b(:,i);
        
        Var.w_AI_B(:,i) = C_BAt(3*i-2:3*i,:)*w_AI';
    end
end

%% Relative Dynamics and Kinematics: Dual Quaternions %%

%Relative frame Initialisation
% x_A = (C_AI*x_I');
% v_BA_A = (C_AI*v_I') - (W_AI1*x_A);
% q_BA = cross_quat(q_BI',q_AI');
% C_BA = Q2DCM(q_BA);
% 
% v_BA_B = C_BA*v_BA_A;
% w_AI_B = (C_BA*w_AI');
% w_BA_B = w_BI'-w_AI_B;

if Switch.Q_rel    
    [Var.t2,Var.y2,Var.r_B] = test_rel_b_eom(w_AI,x_A',v_BA_B',w_BA_B',q_BA');
    for j = 1:length(Var.y2)
        Var.norm_rb(j) = norm(Var.r_B(j,1:3));
        Var.norm_ra(j) = norm(Var.y2(j,1:3));
    end
end

if Switch.DQ 
    %change to DQ format
    dI = dq_inertia(SC.mass.m_i,SC.I.I_total);
    dw_BA = [w_BA_B' 0 v_BA_B' 0];
    dq_BA = Q2DQ(q_BA,x_A',2)';

    %warning('off','all')

    [Var.t3,Var.y3,Var.dqr_A,Var.dqr_B] = test_rel_dq_eom(dI,w_AI,dq_BA,dw_BA);
    
    for j = 1:length(Var.y3)
        Var.norm_dqra(j) = norm(Var.dqr_A(j,1:3));
        Var.norm_dqrb(j) = norm(Var.dqr_B(j,1:3));
        
        C_BAtt(3*j-2:3*j,:) = Q2DCM(Var.y3(j,1:4)');
        C_ABtt(3*j-2:3*j,:) = C_BAtt(3*j-2:3*j,:)';
        
        C_AItt(3*j-2:3*j,:) = Q2DCM([0;0;sin((w_AI(3)*Var.t3(j))/2);cos((w_AI(3)*Var.t3(j))/2)]);
        C_IAtt(3*j-2:3*j,:) = C_AItt(3*j-2:3*j,:)';
        
        Var.dqr_I(j,1:3) = (C_IAtt(3*j-2:3*j,:) * Var.dqr_A(j,1:3)')';
        Var.dqv_I(j,1:3) = (C_IAtt(3*j-2:3*j,:) * (C_ABtt(3*j-2:3*j,:)*Var.y3(j,13:15)' + (W_AI1*Var.dqr_A(j,1:3)')))';
        
        C_BAtt(3*j-2:3*j,:) = Q2DCM(Var.y3(j,1:4)');
        Var.dqw_AI_B(:,j) = C_BAtt(3*j-2:3*j,:)*w_AI';
    end
end

%% Inertial Descent: Non-linear %%

if Switch.DOF6    
    y = test_inert_nonlineom(I,m_sc,x_I,v_I,q_BI,w_BI,Th_B,Th_dot_B,g,u,tdot,vk,vvv,1);    
end

%% Inertial Descent: Linear %%

if Switch.DOF6_lin 
    [tspan,tode4,y1] = test_inert_lineom(I,m_sc,x_I,v_I,q_BI,w_BI,Th_B,Th_dot_B,g,t,y,1);    
end

dyn_block_plots();
